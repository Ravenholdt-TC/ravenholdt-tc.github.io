<h1>{{ page.title }}</h1>
<p>
  This chart shows the impact of artifact relic traits on your DPS. You will see how much an additional
  trait is worth compared to additional item levels on your weapon.
</p>
<p>
  The numbers in the chart show the amount of item levels or traits. Trait simulations <em>only</em> show
  the increase from that particular trait.
</p>
<p>
  In order to compare relics with this chart, you have to add the values for the trait and the weapon item
  level increase. However, you should <b>simulate your own character</b> to find your best setup. These
  simulations are based on predefined gear sets instead of your own, after all. This means data shown here
  <b>depends heavily</b> on the used profile with its talents, legendaries etc. and is rather giving an outlook.
  If your character is different from the setup used here, personal simulations are recommended.
</p>
<div id="chart_div" style="width: 100%; height: {{ page.chartheight }}"></div>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChart);

  function excludeEmptyRows(dataTable)
  {
    var view = new google.visualization.DataView(dataTable);
    var rowIndexes = view.getFilteredRows([{column: 1, value: null}]);
    view.hideRows(rowIndexes);
    return view.toDataTable();
  }

  function drawChart() {
    var columntypes = ['string'];
    for (var i = 0; i < {{ page.num_ilevel_values }}; i++) {
      columntypes.push('number'); // Value
      columntypes.push('string'); // Annotation
    }
    var query = new google.visualization.Query('/{{ page.csvfile }}', {
      csvColumns: columntypes,
      csvHasHeader: false
    });
    query.send(handleQueryResponse);
  }

  function handleQueryResponse(response) {
    if (response.isError()) {
      alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
      return;
    }

    var data = response.getDataTable();

    // Sort by last column (relic ilevel), then 3 relics (column 5)
    data.sort([{column: data.getNumberOfColumns() - 1, desc: true}, {column: 5, desc: true}]);

    // Mark annotation columns
    for (var col = 2; col < data.getNumberOfColumns(); col += 2) {
      data.setColumnProperties(col, {type:'string', role:'annotation'})
    }

    // Add Tooltip columns
    for (var col = 3; col <= data.getNumberOfColumns(); col += 3) {
      data.insertColumn(col, { type: 'string', role: 'tooltip', 'p': { 'html': true } });
    }

    // Calculate Differences
    for (var row = 0; row < data.getNumberOfRows(); row++) {
      var prevVal = 0;
      for (var col = 1; col < data.getNumberOfColumns(); col += 3) {
        var curVal = data.getValue(row, col)
        var stepVal = curVal - prevVal;
        var tooltip = '<div class="chart-tooltip"><b>' + data.getValue(row, col + 1) + 'x ' + data.getValue(row, 0) +
          '</b><br><b>Total:</b> ' + formatNumber(curVal.toFixed()) +
          '<br><b>Increase:</b> ' + formatNumber(stepVal.toFixed()) + '</div>';
        data.setValue(row, col + 2, tooltip);
        data.setValue(row, col, stepVal);
        prevVal = curVal;
      }
    }

    // Set chart options
    var bgcol = isDarkTheme() ? '#222' : '#FFF';
    var textcol = isDarkTheme() ? '#CCC' : '#000';
    var options = {
      title:'{{ page.charttitle }}',
      backgroundColor: bgcol,
      chartArea:{
        top: 50,
        bottom: 100,
        left: 150,
        right: 50
      },
      hAxis: {
        title: 'DPS Increase',
        gridlines: {
          count: 20
        },
        viewWindow: {
          min: 0
        },
        textStyle: {
          color: textcol,
        },
        titleTextStyle: {
          color: textcol,
        }
      },
      vAxis: {
        textStyle: {
          fontSize: 12,
          color: textcol,
        },
        titleTextStyle: {
          color: textcol,
        }
      },
      annotations: {
        textStyle: {
          fontSize: 10,
        },
      },
      titleTextStyle: {
        color: textcol,
      },
      tooltip: {
        isHtml: true
      },
      legend: {
        position: "none"
      },
      isStacked: true
    };

    // Instantiate and draw our chart, passing in some options.
    var chart = new google.visualization.BarChart(document.getElementById('chart_div'));
    chart.draw(excludeEmptyRows(data), options);
  }
</script>
